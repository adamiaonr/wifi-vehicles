#!/bin/bash

if [ $# -lt 2 ]
then
	echo "usage : $0 <protocol> <trace-nr> (if protocol = 'udp': <udp-bitrate>)"
	exit 1
fi

# kill outstanding scritps
pkill -f iperf3-to-mobile
pkill -f get-ntp-accuracy

# create dirs (if not available already)
output_dir=/home/pi/workbench/range-tests/vehicular-traces/trace-$2/$(iw wlx24050f6dae36 info | awk '/channel/ {print $2}')
if [ ! -d "$output_dir" ]
then
	mkdir -p "$output_dir"
fi

# handle bitrate arg
# run scripts
bitrate="X"
if [ "$1" == "udp" ]
then

	if [ $# -lt 3 ]
	then
		echo "usage : $0 <protocol> <trace-nr> <udp-bitrate>"
		exit 1
	fi

	bitrate=$3
	/home/pi/workbench/scripts/iperf3-to-mobile.raspbian.sh $1 $2 "$output_dir" 10.10.10.111 5203 $bitrate wlx24050f6dae36 &

else

	/home/pi/workbench/scripts/iperf3-to-mobile.raspbian.sh $1 $2 "$output_dir" 10.10.10.111 5203 wlx24050f6dae36 &
fi

# python /home/pi/workbench/scripts/iperf3-to-mobile.raspbian.py --restart-ntp --protocol $1 --bitrate $bitrate --ip-server 10.10.10.111 --port 5203 --iface wlx24050f6dae36 --output-dir /home/pi/workbench/range-tests/vehicular-traces/trace-$2/$(iw wlx24050f6dae36 info | awk '/channel/ {print $2}') &
python /home/pi/workbench/scripts/get-ntp-accuracy.py --output-dir "$output_dir" &

exit 0


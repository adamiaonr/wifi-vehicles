#!/bin/bash

if [ $# -lt 2 ]
then
	echo "usage : $0 <protocol> <trace-nr> (if protocol = 'udp': <udp-bitrate>)"
	echo "options : "
	echo "    <protocol> : 'tcp' or 'udp'"
	echo "    <trace-nr> : nr. of trace to use in logs. 3 digit number w/ leading zeroes, e.g.: '041'"
	echo "    <udp-bitrate> : target bitrate in Mbps, if 'udp' is chosen as <protocol>, e.g. '50' for 50 Mbps."
	exit 1
fi

# kill outstanding scritps
pkill -f iperf3-to-mobile
pkill -f get-ntp-accuracy

# create dirs (if not available already)
# output_dir=/home/adamiaonr/workbench/range-tests/vehicular-traces/trace-$2/$(iw wlx24050f9e2cb1 info | awk '/channel/ {print $2}')
# output_dir=/home/adamiaonr/workbench/range-tests/vehicular-traces/trace-$2/$(iw wlx24050f615114 info | awk '/channel/ {print $2}')
output_dir=/home/adamiaonr/workbench/range-tests/vehicular-traces/trace-$2
mkdir -p "$output_dir"

# handle bitrate arg
bitrate="X"
if [ "$1" == "udp" ]
then

	if [ $# -lt 3 ]
	then
		echo "usage : $0 <protocol> <trace-nr> <udp-bitrate>"
		exit 1
	fi

	bitrate=$3
fi

# set wlan short and long retry options to 10 and 7, respectively...
wiphy="phy"$(iw dev wlx24050f615114 info | awk '/wiphy/ {print $2}')
iw phy $wiphy set retry short 10 long 7

# run scripts
python /home/adamiaonr/workbench/wifi-vehicles/wifi-assist/src/data-collection/iperf3-to-mobile.py --restart-ntp --protocol $1 --bitrate $bitrate --ip-server 10.10.12.1 --port 5203 --iface wlx24050f615114 --output-dir "$output_dir" &
python /home/adamiaonr/workbench/wifi-vehicles/wifi-assist/src/data-collection/get-ntp-accuracy.py --output-dir "$output_dir" &
python /home/adamiaonr/workbench/wifi-vehicles/wifi-assist/src/data-collection/bitrate-adapt-stats.py --input-dir "/sys/kernel/debug/ieee80211" --output-dir "$output_dir" &

exit 0

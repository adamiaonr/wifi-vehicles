#!/bin/bash

if [ $# -lt 3 ]
then
    echo "usage : $0 <remote-login> <server-ip> <server-port> <trace-nr>"
    exit 1
fi

login=$1
ip=$2
port=$3
trace_nr=$4

# FIXME : ugly hack to cope w/ lack of xargs' '-r' option on mac-os
xargs_cmd="xargs -r"
if [ "$login" == "adamiaonr@10.10.10.141" ]
then
	xargs_cmd="xargs"
fi

# iperf3 server on backbone
ssh -i $HOME/.ssh/it "$login" "ps -ef | grep iperf3 | grep $port | grep -v grep | awk '{print \$2}' | sudo $xargs_cmd kill -9; iperf3 -s -B $ip -p $port &> /dev/null < /dev/null &"
# FIXME: do this only in ONE client
if [ "$trace_nr" ]
then
	ssh -i $HOME/.ssh/it "$login" "run-servers $trace_nr &> /dev/null < /dev/null &"
fi

# FIXME : we don't need to restart ap scripts over and over
# ap scripts
#ip=$(ifconfig wlan-txrx | awk -F ':' '/inet addr/{print $2}' | awk -F. '{OFS=".";NF--;print $0;}')
#ssh -i $HOME/.ssh/it root@$ip.1 "kill-ap; (run-ap $3 > /dev/null 2>&1)&"

exit 0

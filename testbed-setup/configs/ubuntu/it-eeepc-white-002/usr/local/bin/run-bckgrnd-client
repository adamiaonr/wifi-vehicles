#!/bin/bash

if [ $# -lt 3 ]
then
	echo "usage : $0 <num-clients> <protocol> <trace-nr>"
	echo "options : "
	echo "    <num-clients> : 'tcp' or 'udp'"
	echo "    <protocol> : 'tcp' or 'udp'"
	echo "    <trace-nr> : nr. of trace to use in logs. 3 digit number w/ leading zeroes, e.g.: '041'"
	echo "    <server-ip> : ip addr of iperf3 server"
	exit 1
fi

nc=$1
proto=$2
trace_nr=$3
ip_srvr=$4
bitrate='X'

if [ "$proto" == "udp" ]
then
	# FIXME : if udp is chosen for the background clients, 10 Mbps bitrate by default
	bitrate='10M'
fi

# kill outstanding scritps
pkill -f get-ntp-accuracy
# create dirs (if not available already)
output_dir=$HOME/workbench/range-tests/vehicular-traces/trace-$trace_nr
mkdir -p "$output_dir"
# update output-dir.txt w/ the current output_dir
echo "$output_dir" > $HOME/workbench/range-tests/vehicular-traces/output-dir.txt
# set wlan short and long retry options to 10 and 7
# FIXME : at this point, i only do this to be consistent among client nodes. however, i don't know why these specific values...
wiphy="phy"$(iw dev wlan-txrx info | awk '/wiphy/ {print $2}')
iw phy $wiphy set retry short 10 long 7

c=0
while [ $c -lt $nc ] 
do
	ifconfig "wlan-bckgrnd-00$(($c + 1))" up
	# FIXME : login username in remote nodes is assumed to be 'it'
	/usr/local/bin/restart-client "$trace_nr" "it@$ip_srvr" "$ip_srvr" $(( 5205 + $c )) "$proto" $bitrate &
	c=$(( $c + 1 ))
done

# force down ifaces of non-participating background clients
while [ $c -lt 2 ] 
do
	ifconfig "wlan-bckgrnd-00$(($c + 1))" down
done

# extract accuracy of time synch via ntp w/ local server
python $HOME/workbench/wifi-vehicles/wifi-assist/src/data-collection/get-ntp-accuracy.py --output-dir "$output_dir" &
# extract bitrate adaptation algorithm stats
python $HOME/workbench/wifi-vehicles/wifi-assist/src/data-collection/bitrate-adapt-stats.py --input-dir "/sys/kernel/debug/ieee80211" --output-dir "$output_dir" &
# extract cpu stats
$HOME/workbench/wifi-vehicles/wifi-assist/src/data-collection/get-cpu.sh $2 "$output_dir" &
# # report status to webserver
# python $HOME/workbench/wifi-vehicles/wifi-assist/src/data-collection/report-status.py --ip 10.10.10.114 --port 8081 --output-dir "$output_dir" --mode "client" &

exit 0
